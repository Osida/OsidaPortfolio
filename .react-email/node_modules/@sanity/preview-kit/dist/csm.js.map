{"version":3,"file":"csm.js","sources":["../src/csm/editIntent.ts","../src/csm/transcode.ts","../src/csm/mapToEditLinks.ts"],"sourcesContent":["import {\n  ContentSourceMapDocument,\n  ContentSourceMapDocuments,\n} from '@sanity/client'\n\nimport { parseNormalisedJsonPath } from './jsonpath'\nimport type { PathSegment, StudioUrl } from './types'\n\n/** @alpha */\nexport type EditLink = `/intent/edit/id=${string};path=${string}`\n\n/** @alpha */\nexport interface EditLinkProps {\n  studioUrl: StudioUrl\n  document: ContentSourceMapDocument\n}\n\n/** @alpha */\nexport type DefineEditLink = (\n  studioUrl: StudioUrl,\n) => (\n  sourceDocument: ContentSourceMapDocuments[number],\n) => `${StudioUrl}${EditLink}`\n\n/** @alpha */\nexport function defineEditLink(\n  _studioUrl: StudioUrl,\n): (\n  sourceDocument: ContentSourceMapDocuments[number],\n  path: string | PathSegment[],\n) => string {\n  const studioUrl = _studioUrl.replace(/\\/$/, '')\n  return (sourceDocument, path) =>\n    `${studioUrl}/intent/edit/id=${\n      sourceDocument._id\n    };path=${encodeJsonPathToUriComponent(path)}`\n}\n\n/** @alpha */\nexport function encodeJsonPathToUriComponent(\n  path: string | PathSegment[],\n): string {\n  const sourcePath = Array.isArray(path) ? path : parseNormalisedJsonPath(path)\n  return encodeURIComponent(\n    sourcePath\n      .map((key, i) =>\n        // eslint-disable-next-line no-nested-ternary\n        typeof key === 'number' ? `[${key}]` : i > 0 ? `.${key}` : key,\n      )\n      .join(''),\n  )\n}\n","/* eslint-disable no-nested-ternary */\nimport type {\n  ContentSourceMap,\n  ContentSourceMapDocuments,\n} from '@sanity/client'\nimport { vercelStegaCombine } from '@vercel/stega'\n\nimport { defineEditLink } from './editIntent'\nimport { encode } from './sourcemap'\nimport type {\n  CreateTranscoderConfig,\n  FilterDefault,\n  PathSegment,\n  Transcoder,\n} from './types'\n\nconst filterDefault: FilterDefault = ({ path }) => {\n  const endPath = path.at(-1)\n  // Never encode slugs\n  if (path.at(-2) === 'slug' && endPath === 'current') {\n    return false\n  }\n\n  // Skip underscored keys, needs better heuristics but it works for now\n  if (typeof endPath === 'string' && endPath.startsWith('_')) {\n    return false\n  }\n\n  /**\n   * Best effort infer Portable Text paths that should not be encoded.\n   * Nothing is for certain, and the below implementation may cause paths that aren't Portable Text and otherwise be safe to encode to be skipped.\n   * However, that's ok as userland can always opt-in with the `encodeSourceMapAtPath` option and mark known safe paths as such, which will override this heuristic.\n   */\n  // If the path ends in [number].children[number].marks[number] it's likely a PortableTextSpan: https://github.com/portabletext/types/blob/e54eb24f136d8efd51a46c6a190e7c46e79b5380/src/portableText.ts#LL154C16-L154C16\n  if (\n    typeof endPath === 'number' &&\n    path.at(-2) === 'marks' &&\n    typeof path.at(-3) === 'number' &&\n    path.at(-4) === 'children' &&\n    typeof path.at(-5) === 'number'\n  ) {\n    return false\n  }\n  // Or if it's [number].markDefs[number].href it's likely a PortableTextLink: https://github.com/portabletext/types/blob/e54eb24f136d8efd51a46c6a190e7c46e79b5380/src/portableText.ts#L163\n  if (\n    endPath === 'href' &&\n    typeof path.at(-2) === 'number' &&\n    path.at(-3) === 'markDefs' &&\n    typeof path.at(-4) === 'number'\n  ) {\n    return false\n  }\n  // Otherwise we have to deal with special properties of PortableTextBlock, and we can't confidently know if it's actually a `_type: 'block'` array item or not.\n  // All we know is that if it is indeed a block, and we encode the strings on these keys it'll for sure break the PortableText rendering and thus we skip encoding.\n  if (typeof endPath === 'string' && typeof path.at(-2) === 'number') {\n    // https://github.com/portabletext/types/blob/e54eb24f136d8efd51a46c6a190e7c46e79b5380/src/portableText.ts#L48-L58\n    if (endPath === 'style' || endPath === 'listItem') {\n      return false\n    }\n  }\n\n  return true\n}\n\nconst TRUNCATE_LENGTH = 20\n\n/** @alpha */\nexport function createTranscoder(config: CreateTranscoderConfig): Transcoder {\n  const { studioUrl, encodeSourceMapAtPath, logger } = config\n\n  const createEditLink = defineEditLink(studioUrl)\n  const report: Record<\n    'encoded' | 'skipped',\n    { path: string; length: number; value: string }[]\n  > = { encoded: [], skipped: [] }\n\n  const transcode = (\n    input: string,\n    sourceDocument: ContentSourceMapDocuments[number],\n    sourcePath: PathSegment[],\n  ): string => {\n    // Allow userland to control when to opt-out of encoding\n    if (\n      (typeof encodeSourceMapAtPath === 'function'\n        ? encodeSourceMapAtPath({ path: sourcePath, filterDefault })\n        : filterDefault({ path: sourcePath, filterDefault })) === false\n    ) {\n      if (logger) {\n        report.skipped.push({\n          path: prettyPathForLogging(sourcePath),\n          value: `${input.slice(0, TRUNCATE_LENGTH)}${\n            input.length > TRUNCATE_LENGTH ? '...' : ''\n          }`,\n          length: input.length,\n        })\n      }\n      return input\n    }\n\n    if (logger) {\n      report.encoded.push({\n        path: prettyPathForLogging(sourcePath),\n        value: `${input.slice(0, TRUNCATE_LENGTH)}${\n          input.length > TRUNCATE_LENGTH ? '...' : ''\n        }`,\n        length: input.length,\n      })\n    }\n\n    return vercelStegaCombine(\n      input,\n      {\n        origin: 'sanity.io',\n        href: createEditLink(sourceDocument, sourcePath),\n      },\n      'auto',\n    )\n  }\n\n  return <R>(result: R, csm: ContentSourceMap) => {\n    // Clear previous reports\n    report.encoded.length = 0\n    report.skipped.length = 0\n\n    return {\n      result: encode(result, csm, (value, sourceDocument, path) =>\n        transcode(value, sourceDocument, path),\n      ),\n      report,\n    }\n  }\n}\n\nfunction prettyPathForLogging(path: PathSegment[]): string {\n  return path\n    .map((segment, index) =>\n      typeof segment === 'number'\n        ? `[${segment}]`\n        : index > 0\n        ? `.${segment}`\n        : segment,\n    )\n    .join('')\n}\n","import type { ContentSourceMap } from '@sanity/client'\n\nimport { defineEditLink } from './editIntent'\nimport { encodeIntoResult } from './sourcemap'\n\n/** @alpha */\nexport function mapToEditLinks<R>(\n  result: R,\n  csm: ContentSourceMap,\n  studioUrl: string,\n): R {\n  const createEditLink = defineEditLink(studioUrl)\n  return encodeIntoResult(result, csm, (_, sourceDocument, path) => {\n    return createEditLink(sourceDocument, path)\n  }) as R\n}\n"],"names":["defineEditLink","_studioUrl","studioUrl","replace","sourceDocument","path","concat","_id","encodeJsonPathToUriComponent","sourcePath","Array","isArray","parseNormalisedJsonPath","encodeURIComponent","map","key","i","join","filterDefault","_ref","endPath","at","startsWith","TRUNCATE_LENGTH","createTranscoder","config","encodeSourceMapAtPath","logger","createEditLink","report","encoded","skipped","transcode","input","push","prettyPathForLogging","value","slice","length","vercelStegaCombine","origin","href","result","csm","encode","segment","index","mapToEditLinks","encodeIntoResult","_"],"mappings":"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"}